name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
    
    - name: Cache uv dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-uv-publish-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-uv-publish-
          ${{ runner.os }}-uv-
    
    - name: Install dependencies
      env:
        UV_HTTP_TIMEOUT: 120s
        UV_CONCURRENT_DOWNLOADS: 1
      run: |
        uv pip install -e '.[dev]'
        uv pip install build twine
    
    - name: Run tests
      run: |
        python scripts/check_code.py --with-tests
    
    - name: Build package
      run: |
        uv build
    
    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/*
    
    - name: Verify installation
      run: |
        pip install dnallm
        python -c "import dnallm; print('DNALLM installed successfully!')"
